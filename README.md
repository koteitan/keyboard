# カスタムキーボード

## 概要

カスタムキーボードは、ブラウザ上で動作するインタラクティブなキーボードアプリケーションです。各キーに割り当てる音の周波数比率を数式で自由に定義し、様々な音律や独自の音階を探求することができます。

## 主な機能

-   **インターフェース**:
    -   qwerty キーボード
    -   マウス
    -   タップ
-   **音程マップ (Expression-based Note Mapping)**:
    -   各キーの音程は、テキストエリア内で `キー = 式` の形式、またはキー名なしの `式` のみの形式で定義します。
        -   例: `a = 440`, `s = a * 3/2`, または単に `3/2`, `(2)^(7/12)` など。
        -   キー名なしの式は、音律の検討や式のリストとして便利ですが、キーボード演奏時には音は鳴りません。
    -   **式の文法 (`<expr>`)**:
        -   **数値**: 整数 (`1`, `440`) や小数 (`1.5`, `0.05`) を使用できます。
        -   **キー参照**: 他のキー名を式の中で使用することで、そのキーの評価済み比率を参照できます (例: `b = a * 2`)。循環参照はエラーとなります。
        -   **演算子**:
            -   `+` (加算)
            -   `-` (減算)
            -   `*` (乗算)
            -   `/` (除算)
            -   `^` (冪乗)
        -   **括弧**: `()` を使用して演算の優先順位を指定できます (例: `(3+2)/5`)。
        -   **注意**: 
            -   式は最終的に基準周波数に乗算される「比率」として評価されます。
            -   `#` で始まる行はコメントとして無視されます。空行も無視されます。
    -   **記述例**:
        -   **12平均律 (C基準で最初の数音を 'q', 'w', 'e' に割り当て)**:
            ```
            q = (2)^(0/12)  # C
            w = (2)^(1/12)  # C#
            e = (2)^(2/12)  # D
            r = (2)^(3/12)  # D#
            t = (2)^(4/12)  # E
            ```
        -   `a = 1` (キー 'a' は基準周波数と同じ音)
        -   `s = a * 3/2` (キー 's' はキー 'a' の完全五度上の音)
        -   `d = (2)^(7/12)` (キー 'd' は基準周波数の12平均律での完全五度上の音)
        -   キー名なしの例 (単独の式): `(2)^(7/12)`
    -   **操作ボタン**:
        -   **ソート**: 音程マップ内の有効なエントリ（キー名あり・なし両方）を、その評価値（周波数比率）の昇順に並べ替えます。元の行のキー名や、キー名なしの形式は維持されます。コメント行や空行の位置も保持されます。
        -   **ラップ**: 音程マップ内の有効な各エントリの式を、指定された「ラッピング単位 `w`」（デフォルトは2）に基づいて正規化します。元の式 `expr` は `(expr) / (w^k)` または `(expr) * (w^k)` の形に変換され、その評価値が `1 <= new_ratio < w` の範囲に収まるように調整されます。
-   **基準周波数**: 基準となる周波数（デフォルト440Hz）を設定できます。音程マップで定義された比率は、この基準周波数に乗算されて最終的な再生周波数が決まります。
-   **音色選択**: サイン波 (sin) またはピアノ音色を選択できます。
-   **音量調整**:
    -   全体のマスターボリュームをスライダーで調整可能。
-   **音律プリセット**:
    -   12平均律、純正律、ピタゴラス音律、ミーントーン、31平均律、53平均律、ボーレン・ピアース音律などのプリセットを選択可能。
    -   選択すると、音程マップがその音律の定義で更新されます。
-   **設定の永続化**: 音程マップの内容、基準周波数、音色、音量、選択中の音律プリセットは、ブラウザのLocalStorageに自動的に保存され、次回訪問時に復元されます。

## クレジット

-   **Product by**: koteitan
-   **Programmed by**: Cline + Gemini 1.5 Pro
-   **Source code**: [GitHub](https://github.com/koteitan/koteitan.github.io/tree/main/keyboard/)
-   **Piano sound**: from Musyng Kite soundfont, provided by [gleitz/midi-js-soundfonts](https://github.com/gleitz/midi-js-soundfonts), licensed under [CC BY-SA 3.0](https://creativecommons.org/licenses/by-sa/3.0/).
