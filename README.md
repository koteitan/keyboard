# カスタムキーボード

## 概要

カスタムキーボードは、ブラウザ上で動作するインタラクティブなキーボードアプリケーションです。各キーに割り当てる音の周波数比率を数式で自由に定義し、様々な音律や独自の音階を探求することができます。

## 主な機能

-   **キーボードインターフェース**: 標準的なQWERTY配列をベースにしたキーボードで演奏できます。
-   **音程マップ (Expression-based Note Mapping)**:
    -   各キーの音程は、テキストエリア内で `キー = 式` の形式で定義します。 (例: `a = 440`, `s = a * 3/2`)
    -   **式の文法 (`<expr>`)**:
        -   **数値**: 整数 (`1`, `440`) や小数 (`1.5`, `0.05`) を使用できます。
        -   **キー参照**: 他のキー名を式の中で使用することで、そのキーの評価済み比率を参照できます (例: `b = a * 2`)。循環参照はエラーとなります。
        -   **演算子**:
            -   `+` (加算)
            -   `-` (減算)
            -   `*` (乗算)
            -   `/` (除算)
            -   `^` (冪乗)
        -   **括弧**: `()` を使用して演算の優先順位を指定できます (例: `(3+2)/5`)。
        -   **注意**: 式は最終的に基準周波数に乗算される「比率」として評価されます。
    -   **例**:
        -   `a = 1` (キー 'a' は基準周波数と同じ音)
        -   `s = 3/2` (キー 's' は基準周波数の完全五度上の音)
        -   `d = (2)^(7/12)` (キー 'd' は基準周波数の12平均律での完全五度上の音)
        -   `f = s * (5/4)` (キー 'f' はキー 's' の音の長三度上の音)
-   **基準周波数**: 基準となる周波数（デフォルト440Hz）を設定できます。音程マップで定義された比率は、この基準周波数に乗算されて最終的な再生周波数が決まります。
-   **音色選択**: サイン波 (sin) またはピアノ音色を選択できます。
-   **音量調整**:
    -   全体のマスターボリュームをスライダーで調整可能。
    -   サイン波の場合、同時発音数に応じて各音のゲインが自動調整され、5音程度まではクリッピングしにくいようになっています。
-   **音律プリセット**:
    -   12平均律、純正律、ピタゴラス音律、ミーントーン、31平均律、53平均律、ボーレン・ピアース音律などのプリセットを選択可能。
    -   選択すると、音程マップがその音律の定義で更新されます。
-   **設定の永続化**: 音程マップの内容、基準周波数、音色、音量、選択中の音律プリセットは、ブラウザのLocalStorageに自動的に保存され、次回訪問時に復元されます。
-   **レスポンシブデザイン**: PCおよびスマートフォンでの表示・操作に対応。
    -   タッチ操作による演奏（ホールド、ドラッグでの音の切り替え）が可能。
    -   キーボードのはみ出しや文字選択の問題に対応済み。

## 使い方

1.  `keyboard/index.html` ファイルをウェブブラウザで開きます。
2.  「設定」セクションで基準周波数、音色、音量、音律プリセットを好みに合わせて調整します。
3.  「音程マップ」セクションのテキストエリアに、各キーの音程を定義する式を入力します（例: `q = 1/1`, `w = 9/8`, `e = 5/4` など）。
4.  PCのキーボード、または画面上のキーをクリック（またはタップ）して音を鳴らします。

## 技術スタック

-   HTML5
-   CSS3 (JavaScriptによる動的適用)
-   JavaScript (ES6+)
-   Web Audio API

## クレジット

-   **Product by**: koteitan
-   **Programmed by**: Cline + Gemini 1.5 Pro
-   **Source code**: [GitHub](https://github.com/koteitan/koteitan.github.io/tree/main/keyboard/)
-   **Piano sound**: from Musyng Kite soundfont, provided by [gleitz/midi-js-soundfonts](https://github.com/gleitz/midi-js-soundfonts), licensed under [CC BY-SA 3.0](https://creativecommons.org/licenses/by-sa/3.0/).

## 今後の展望・課題 (例)

-   ピアノ音源の音量調整機能の改善（マスターボリューム、同時発音数に応じた調整への対応）。
-   より詳細で正確な音律プリセットの追加・拡充。
-   ユーザーが独自のプリセットを保存・管理できる機能。
-   MIDI入出力対応。
